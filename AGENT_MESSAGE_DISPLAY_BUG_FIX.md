# Bug ä¿®å¤æŠ¥å‘Šï¼šAI Agent æ¶ˆæ¯æ˜¾ç¤ºé—®é¢˜

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ AI Agent è®°è´¦åŠŸèƒ½æ—¶é‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š
1. **React Native æ¸²æŸ“é”™è¯¯**ï¼š`Text strings must be rendered within a <Text> component`
2. **æ¶ˆæ¯é¡ºåºæ··ä¹±**ï¼šåæ€æ¶ˆæ¯"æˆ‘æ¥ä¸ºæ‚¨è®°å½•è¿™ç¬”åˆé¤æ¶ˆè´¹..."æ˜¾ç¤ºåœ¨äº¤æ˜“è¯¦æƒ…ä¹‹åï¼Œé€ æˆè§†è§‰æ··ä¹±

## ğŸ› é—®é¢˜ 1ï¼šText ç»„ä»¶æ¸²æŸ“é”™è¯¯

### æ ¹æœ¬åŸå› 
åœ¨ [TransactionDetailDisplay.tsx](src/components/agent/embedded/TransactionDetailDisplay.tsx#L128-L129) ä¸­ï¼š

```tsx
{transaction.attachmentCount && transaction.attachmentCount > 0 && 
  renderInfoRow('attach-outline', 'é™„ä»¶', `${transaction.attachmentCount} ä¸ª`)}
```

**é—®é¢˜ï¼š** å½“ `attachmentCount` ä¸º `0` æ—¶ï¼š
- JavaScript é€»è¾‘ï¼š`0 && condition` è¿”å› `0`ï¼ˆä¸æ˜¯ `false`ï¼‰
- React Native å°è¯•ç›´æ¥æ¸²æŸ“æ•°å­— `0`
- åœ¨ React Native ä¸­ï¼Œæ•°å­—å¿…é¡»åœ¨ `<Text>` ç»„ä»¶å†…ï¼Œå¯¼è‡´é”™è¯¯

### è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹æ¡ä»¶åˆ¤æ–­ä¸ºæ˜¾å¼å¸ƒå°”å€¼æ¯”è¾ƒï¼š

```tsx
{(transaction.attachmentCount ?? 0) > 0 && 
  renderInfoRow('attach-outline', 'é™„ä»¶', `${transaction.attachmentCount} ä¸ª`)}
```

**æ”¹è¿›ç‚¹ï¼š**
- ä½¿ç”¨ nullish coalescing operator (`??`) å¤„ç†å¯èƒ½çš„ `undefined`
- ç›´æ¥æ¯”è¾ƒå¤§å°ï¼Œè¿”å›å¸ƒå°”å€¼è€Œä¸æ˜¯æ•°å­—
- é¿å… React Native æ¸²æŸ“è£¸æ•°å­—

## ğŸ› é—®é¢˜ 2ï¼šåæ€æ¶ˆæ¯é¡ºåºæ··ä¹±

### æ ¹æœ¬åŸå› 

åœ¨ [useStatefulAgentChat.ts](src/hooks/useStatefulAgentChat.ts#L638-L641) çš„ `onReflection` å›è°ƒä¸­ï¼š

```tsx
setMessages(prev => {
  const aiIndex = prev.findIndex(m => m.id === aiMsgId);
  if (aiIndex >= 0) {
    return [...prev.slice(0, aiIndex), reflectionMessage, ...prev.slice(aiIndex)];
  }
  return [...prev, reflectionMessage];
});
```

**é—®é¢˜åˆ†æï¼š**

1. **æ‰§è¡Œæ—¶åºï¼š**
   ```
   ç”¨æˆ·è¾“å…¥ "åˆé¤15"
   â†“
   å·¥å…·è°ƒç”¨ï¼šcreate_transaction (åˆ›å»ºäº¤æ˜“)
   â†“
   å·¥å…·è°ƒç”¨ï¼šrender_transaction_detail (æ¸²æŸ“äº¤æ˜“è¯¦æƒ…)
   â†“
   çŠ¶æ€å˜æ›´ï¼šexecuting â†’ reflecting
   â†“
   Reflection ç”Ÿæˆåæ€æ¶ˆæ¯ï¼š"æˆ‘æ¥ä¸ºæ‚¨è®°å½•è¿™ç¬”åˆé¤æ¶ˆè´¹..."
   â†“
   ä»»åŠ¡å®Œæˆ
   ```

2. **æ’å…¥é€»è¾‘é—®é¢˜ï¼š**
   - åæ€æ¶ˆæ¯è¢«æ’å…¥åˆ° `aiMsgId`ï¼ˆAI å ä½ç¬¦ï¼‰ä¹‹å‰
   - ä½†æ­¤æ—¶ AI æ¶ˆæ¯åé¢å·²ç»æœ‰äº†å·¥å…·è°ƒç”¨ç»“æœï¼ˆäº¤æ˜“è¯¦æƒ…ï¼‰
   - å¯¼è‡´åæ€æ¶ˆæ¯æ˜¾ç¤ºåœ¨äº¤æ˜“è¯¦æƒ…ä¹‹åï¼Œé€ æˆæ—¶åºæ··ä¹±

3. **ç”¨æˆ·è§†è§’ï¼š**
   ```
   [ç”¨æˆ·] åˆé¤15
   [AI å·¥å…·] åˆ›å»ºäº¤æ˜“ âœ“
   [AI æ¸²æŸ“] äº¤æ˜“è¯¦æƒ…å¡ç‰‡
   [AI åæ€] æˆ‘æ¥ä¸ºæ‚¨è®°å½•è¿™ç¬”åˆé¤æ¶ˆè´¹... â† é¡ºåºé”™è¯¯ï¼
   ```

### è§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ `onReflection` å›è°ƒï¼Œå°†åæ€æ¶ˆæ¯è¿½åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨æœ«å°¾ï¼š

```tsx
// åæ€æ¶ˆæ¯è¿½åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨æœ«å°¾
setMessages(prev => [...prev, reflectionMessage]);
```

**æ”¹è¿›ç‚¹ï¼š**
- ä¿æŒæ¶ˆæ¯æ—¶åºçš„è‡ªç„¶é¡ºåº
- åæ€å‘ç”Ÿåœ¨å·¥å…·è°ƒç”¨ä¹‹åï¼Œæ¶ˆæ¯ä¹Ÿåº”è¯¥æ˜¾ç¤ºåœ¨ä¹‹å
- é¿å…æ’å…¥é€»è¾‘å¯¼è‡´çš„æ··ä¹±

### UI ä¼˜åŒ–

ä¸ºäº†è®©åæ€æ¶ˆæ¯ä»¥æ›´ä½è°ƒçš„æ–¹å¼æ˜¾ç¤ºï¼Œåœ¨ [MessageGroup.tsx](src/components/agent/MessageGroup.tsx) ä¸­æ·»åŠ ç‰¹æ®Šå¤„ç†ï¼š

```tsx
// åæ€æ¶ˆæ¯ - ä»¥ä½è°ƒæ–¹å¼æ˜¾ç¤º
if (isReflection) {
  return (
    <View key={message.id} style={styles.reflectionRow}>
      <Icon name="bulb-outline" size={12} color={Colors.textDisabled} style={styles.reflectionIcon} />
      <Text style={styles.reflectionText}>{message.content}</Text>
    </View>
  );
}
```

**æ ·å¼ç‰¹ç‚¹ï¼š**
- å°å­—å·ï¼ˆ`FontSizes.xs`ï¼‰
- ä½é¥±å’Œåº¦ï¼ˆ`opacity: 0.6`ï¼‰
- æ–œä½“æ–‡å­—ï¼ˆ`fontStyle: 'italic'`ï¼‰
- ç¯æ³¡å›¾æ ‡æç¤ºè¿™æ˜¯åæ€å†…å®¹
- ç±»ä¼¼äº"æ€è€ƒè¿‡ç¨‹"çš„ä½è°ƒæ˜¾ç¤º

## âœ… ä¿®å¤æ–‡ä»¶åˆ—è¡¨

1. **src/components/agent/embedded/TransactionDetailDisplay.tsx**
   - ä¿®å¤é™„ä»¶æ•°é‡æ¡ä»¶æ¸²æŸ“é€»è¾‘
   - é¿å… React Native æ¸²æŸ“è£¸æ•°å­—

2. **src/hooks/useStatefulAgentChat.ts**
   - ä¿®æ”¹åæ€æ¶ˆæ¯æ’å…¥é€»è¾‘
   - å°†æ¶ˆæ¯è¿½åŠ åˆ°åˆ—è¡¨æœ«å°¾è€Œä¸æ˜¯æ’å…¥åˆ°ä¸­é—´

3. **src/components/agent/MessageGroup.tsx**
   - å¯¼å…¥ `Icon` ç»„ä»¶
   - æ·»åŠ  `reflection` ç±»å‹æ¶ˆæ¯çš„ç‰¹æ®Šæ¸²æŸ“
   - æ·»åŠ  `reflectionRow`ã€`reflectionIcon`ã€`reflectionText` æ ·å¼

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šé™„ä»¶æ•°é‡ä¸º 0
```typescript
// ä¹‹å‰ä¼šæŠ¥é”™ï¼Œç°åœ¨æ­£å¸¸
transaction.attachmentCount = 0;
// ä¸æ˜¾ç¤ºé™„ä»¶è¡Œ
```

### æµ‹è¯•åœºæ™¯ 2ï¼šæ¶ˆæ¯é¡ºåº
```
é¢„æœŸé¡ºåºï¼š
1. [ç”¨æˆ·] åˆé¤15
2. [AI å·¥å…·] åˆ›å»ºäº¤æ˜“ âœ“
3. [AI æ¸²æŸ“] äº¤æ˜“è¯¦æƒ…å¡ç‰‡
4. [AI åæ€] ğŸ’¡ ç”¨æˆ·è¾“å…¥'åˆé¤15'ï¼Œç³»ç»Ÿå·²æˆåŠŸåˆ›å»º... ï¼ˆä½è°ƒæ˜¾ç¤ºï¼‰

âœ… ç°åœ¨æ˜¾ç¤ºæ­£ç¡®
```

### æµ‹è¯•åœºæ™¯ 3ï¼šåæ€æ¶ˆæ¯æ ·å¼
- ç¯æ³¡å›¾æ ‡ âœ“
- å°å­—å·ã€ä½é¥±å’Œåº¦ âœ“
- æ–œä½“æ–‡å­— âœ“
- ä¸å½±å“ä¸»è¦å†…å®¹çš„é˜…è¯» âœ“

## ğŸ“Š æ€§èƒ½å½±å“

- **é›¶æ€§èƒ½å½±å“**ï¼šåªæ˜¯ä¿®æ”¹äº†æ¡ä»¶åˆ¤æ–­å’Œæ’å…¥ä½ç½®
- **å†…å­˜ä¼˜åŒ–**ï¼šé¿å…äº†é”™è¯¯å¯¼è‡´çš„ç»„ä»¶é‡æ¸²æŸ“

## ğŸ¯ ç¬¦åˆ Guidelines

æ ¹æ® [guidelines.md](guidelines.md) ç¬¬ 7 æ¡ï¼š
> é’ˆå¯¹ AI ç¼–å†™çš„æç¤ºè¯ï¼Œç¦æ­¢ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘ï¼

**æˆ‘ä»¬çš„å®ç°ï¼š**
- åæ€æ¶ˆæ¯ä»¥ä½è°ƒæ–¹å¼æ˜¾ç¤ºï¼Œä¸å¹²æ‰°ä¸»è¦å†…å®¹
- ç”¨æˆ·å¯ä»¥çœ‹åˆ° AI çš„æ€è€ƒè¿‡ç¨‹ï¼Œä½†ä¸ä¼šé€ æˆæ··ä¹±
- ä¿æŒäº† ReAct æ¨¡å¼çš„å®Œæ•´æ€§ï¼ŒåŒæ—¶ä¼˜åŒ–äº† UX

## ğŸ‰ ä¿®å¤æ•ˆæœ

### ä¹‹å‰
```
âŒ React Native æŠ¥é”™ï¼šText strings must be rendered...
âŒ æ¶ˆæ¯é¡ºåºæ··ä¹±ï¼š"æˆ‘æ¥ä¸ºæ‚¨è®°å½•..."æ˜¾ç¤ºåœ¨äº¤æ˜“è¯¦æƒ…ä¹‹å
```

### ä¹‹å
```
âœ… ä¸å†æœ‰ React Native æ¸²æŸ“é”™è¯¯
âœ… æ¶ˆæ¯æŒ‰æ—¶åºæ­£ç¡®æ˜¾ç¤º
âœ… åæ€æ¶ˆæ¯ä»¥ä½è°ƒæ–¹å¼å‘ˆç°ï¼Œä¸å½±å“é˜…è¯»
```

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **React Native æ¡ä»¶æ¸²æŸ“é™·é˜±**
   - é¿å…ä½¿ç”¨ `value && component`ï¼Œå½“ value ä¸º 0 æ—¶ä¼šå‡ºé”™
   - ä½¿ç”¨æ˜¾å¼å¸ƒå°”åˆ¤æ–­ï¼š`value > 0 && component`

2. **æ¶ˆæ¯é¡ºåºç®¡ç†**
   - æ’å…¥æ¶ˆæ¯æ—¶è¦è€ƒè™‘æ—¶åºå…³ç³»
   - è¿½åŠ åˆ°æœ«å°¾æ¯”æ’å…¥åˆ°ä¸­é—´æ›´å®‰å…¨

3. **UI åˆ†çº§æ˜¾ç¤º**
   - ä¸»è¦å†…å®¹ï¼šæ­£å¸¸æ˜¾ç¤º
   - è¾…åŠ©ä¿¡æ¯ï¼ˆå·¥å…·è°ƒç”¨ï¼‰ï¼šå¯æŠ˜å 
   - è°ƒè¯•ä¿¡æ¯ï¼ˆæ€è€ƒã€åæ€ï¼‰ï¼šä½è°ƒæ˜¾ç¤º

## ğŸ” ç›¸å…³æ—¥å¿—åˆ†æ

```
statefulAgent.ts:1020 ğŸ“¥ [StatefulAgent] ========== LLM RESPONSE END ==========
useStatefulAgentChat.ts:648 ğŸ“ [Step] tool_call ğŸ”§ è°ƒç”¨å·¥å…·: render_transaction_detail
renderTools.ts:293 ğŸ¨ [renderTransactionDetailTool] Rendering transaction detail: 448
stateMachine.ts:325 ğŸ”„ [StateMachine] executing â†’ reflecting 
useStatefulAgentChat.ts:583 ğŸ“Š [State] executing -> reflecting
reflector.ts:362 ğŸ” [Reflector] Thought: ç”¨æˆ·è¾“å…¥'åˆé¤15'ï¼Œç³»ç»Ÿå·²æˆåŠŸåˆ›å»º...
```

**å…³é”®è§‚å¯Ÿï¼š**
- å·¥å…·è°ƒç”¨å®Œæˆåæ‰è¿›å…¥åæ€é˜¶æ®µ
- åæ€æ¶ˆæ¯åº”è¯¥æ˜¾ç¤ºåœ¨å·¥å…·ç»“æœä¹‹å
- ä¿®å¤åçš„é¡ºåºä¸æ—¥å¿—æ—¶åºä¸€è‡´ âœ“

## ğŸ¨ UI æ•ˆæœé¢„æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆé¤15                          â”‚ â† ç”¨æˆ·æ¶ˆæ¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ äº¤æ˜“ç®¡ç† âœ“ å·²å®Œæˆ            â”‚ â† å·¥å…·è°ƒç”¨ï¼ˆå¯æŠ˜å ï¼‰
â”‚ ğŸ¨ æ¸²æŸ“äº¤æ˜“è¯¦æƒ… âœ“ å·²å®Œæˆ        â”‚
â”‚                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ´ åˆé¤                     â”‚ â”‚ â† äº¤æ˜“è¯¦æƒ…å¡ç‰‡
â”‚ â”‚ -Â¥15.00                     â”‚ â”‚
â”‚ â”‚ ğŸ“… æ—¶é—´: 2025å¹´12æœˆ12æ—¥...  â”‚ â”‚
â”‚ â”‚ ğŸ·ï¸ åˆ†ç±»: é¤é¥®              â”‚ â”‚
â”‚ â”‚ ...                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚
â”‚ ğŸ’¡ ç”¨æˆ·è¾“å…¥'åˆé¤15'ï¼Œç³»ç»Ÿå·²... â”‚ â† åæ€æ¶ˆæ¯ï¼ˆä½è°ƒæ˜¾ç¤ºï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆå¹¶æµ‹è¯•  
**å½±å“èŒƒå›´ï¼š** TransactionDetailDisplayã€useStatefulAgentChatã€MessageGroup  
**å‘åå…¼å®¹ï¼š** âœ… æ˜¯  
**éœ€è¦é‡å¯ï¼š** âœ… éœ€è¦é‡æ–°åŠ è½½ React Native
