# Agent æ¶ˆæ¯é¡ºåºä¿®å¤ - æ ¹æœ¬åŸå› åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## æ ¸å¿ƒé—®é¢˜åˆ†æ

### é—®é¢˜ç°è±¡
1. **æ¶ˆæ¯æ°”æ³¡ä¸­è¾“å‡ºçš„ç»“æœé¡ºåºä¸€ç›´åœ¨åŠ¨æ€å˜åŒ–**
2. **æ€»ç»“æ€§æ–‡æœ¬åœ¨å·¥å…·è°ƒç”¨å®Œæˆä¹‹å‰å°±æ˜¾ç¤ºäº†**ï¼ˆå¦‚"å·²æˆåŠŸè®°å½•ä¸€ç¬”ä¿®ç©ºè°ƒçš„æ”¯å‡º"åœ¨æ¸²æŸ“å·¥å…·è°ƒç”¨ä¹‹å‰æ˜¾ç¤ºï¼‰
3. **æ€è€ƒæ¶ˆæ¯åœ¨å·¥å…·ç»“æœä¹‹å‰æ˜¾ç¤º**ï¼ˆå¦‚"æˆ‘æ‰¾åˆ°äº†'æ•°ç ç»´ä¿®'åˆ†ç±»"åœ¨åˆ†ç±»ç®¡ç†å·¥å…·å‡ºç»“æœä¹‹å‰æ˜¾ç¤ºï¼‰

### æ ¹æœ¬åŸå› 

ä»ä»£ç åˆ†æå‘ç°ï¼Œæ¶ˆæ¯å¤„ç†æœ‰**ä¸¤ä¸ªå¹¶è¡Œçš„å¼‚æ­¥è·¯å¾„**ï¼š

#### è·¯å¾„ 1ï¼šStream è·¯å¾„ï¼ˆAI æ–‡æœ¬è¾“å‡ºï¼‰
```typescript
// AgentContext.tsx ç¬¬414-421è¡Œ
for await (const chunk of stream) {
  if (chunk.messages && chunk.messages.length > 0) {
    const lastMsg = chunk.messages[chunk.messages.length - 1];
    if (lastMsg instanceof AIMessage && typeof lastMsg.content === 'string') {
      finalContent = lastMsg.content;
      // âŒ é—®é¢˜ï¼šç«‹å³æ›´æ–°æ¶ˆæ¯åˆ°ç•Œé¢
      setMessages(prev => prev.map(m => m.id === aiMsgId ? {...m, content: finalContent} : m));
    }
  }
}
```

#### è·¯å¾„ 2ï¼šCallback è·¯å¾„ï¼ˆå·¥å…·è°ƒç”¨å’Œç»“æœï¼‰
```typescript
// AgentContext.tsx ç¬¬306-400è¡Œ
onStep: (step: AgentStepEvent) => {
  if (step.type === 'tool_call') {
    // æ·»åŠ å·¥å…·è°ƒç”¨æ¶ˆæ¯
    setMessages(prev => [...prev, toolCallMsg]);
  }
  if (step.type === 'tool_result') {
    // æ·»åŠ å·¥å…·ç»“æœæ¶ˆæ¯
    setMessages(prev => [...prev, toolResultMsg]);
  }
}
```

### æ—¶åºå›¾ï¼ˆä¿®å¤å‰ï¼‰

```
ç”¨æˆ·è¾“å…¥ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                                                                    â–¼
                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                         â”‚  statefulAgent    â”‚
                                                         â”‚     stream()      â”‚
                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                                    â”‚                                    â”‚
                              â–¼                                    â–¼                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Chunk 1 (æ–‡æœ¬)   â”‚              â”‚  Chunk 2 (å·¥å…·)   â”‚              â”‚  Chunk 3 (æ–‡æœ¬)   â”‚
                    â”‚  "æˆ‘æ¥å¸®æ‚¨è®°å½•..." â”‚              â”‚  category.search â”‚              â”‚  "å·²æˆåŠŸè®°å½•..." â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                                  â”‚                                  â”‚
                              â–¼                                  â”‚                                  â–¼
                    setMessages(update)                          â”‚                        setMessages(update)
                              â”‚                                  â”‚                                  â”‚
                              â–¼                                  â”‚                                  â–¼
                    âœ… ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢                             â”‚                        âœ… ç«‹å³æ˜¾ç¤ºåœ¨ç•Œé¢ï¼ˆé”™è¯¯ï¼ï¼‰
                                                                 â”‚
                                                                 â–¼
                                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                    â”‚  onStep callback è§¦å‘     â”‚
                                                    â”‚  (å¼‚æ­¥ï¼Œå¯èƒ½å»¶è¿Ÿ)          â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                    setMessages(add tool call)
                                                              â”‚
                                                              â–¼
                                                    å·¥å…·æ‰§è¡Œ...
                                                              â”‚
                                                              â–¼
                                                    setMessages(add tool result)
                                                              â”‚
                                                              â–¼
                                                    âœ… æ˜¾ç¤ºåœ¨ç•Œé¢ï¼ˆä½†å·²ç»æ™šäº†ï¼ï¼‰

âŒ ç»“æœï¼šç”¨æˆ·å…ˆçœ‹åˆ°"å·²æˆåŠŸè®°å½•..."ï¼Œç„¶åæ‰çœ‹åˆ°å·¥å…·è°ƒç”¨å’Œç»“æœ
```

### ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

1. **Stream æ˜¯æ¨é€å¼çš„**ï¼šæ¯ä¸ª chunk åˆ°è¾¾æ—¶ç«‹å³å¤„ç†
2. **Callback æ˜¯å¼‚æ­¥çš„**ï¼š`onStep` å›è°ƒçš„è§¦å‘æ—¶æœºä¸ç¡®å®š
3. **React çŠ¶æ€æ›´æ–°æ˜¯å¼‚æ­¥æ‰¹å¤„ç†**ï¼šå¤šä¸ª `setMessages` è°ƒç”¨å¯èƒ½ä¸æŒ‰ä»£ç æ‰§è¡Œé¡ºåºåº”ç”¨
4. **æ²¡æœ‰é¡ºåºä¿è¯æœºåˆ¶**ï¼šæ¶ˆæ¯ ID ä½¿ç”¨ `Date.now()`ï¼Œåœ¨åŒä¸€æ¯«ç§’å†…å¯èƒ½å†²çª

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

1. **å¼•å…¥æ¶ˆæ¯åºå·ï¼ˆsequenceï¼‰**ï¼šä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…é€’å¢çš„åºå·
2. **å»¶è¿Ÿ AI æ–‡æœ¬è¾“å‡º**ï¼šä¸åœ¨ stream ä¸­ç«‹å³æ›´æ–°ï¼Œè€Œæ˜¯æ”¶é›†æ‰€æœ‰ chunkï¼Œåœ¨æœ€åç»Ÿä¸€æ·»åŠ 
3. **æŒ‰åºå·æ’åº**ï¼šåœ¨ finally å—ä¸­å¯¹æ‰€æœ‰æ¶ˆæ¯æŒ‰åºå·æ’åºï¼Œç¡®ä¿æ˜¾ç¤ºé¡ºåºæ­£ç¡®
4. **æ·»åŠ è¯¦ç»†æ—¥å¿—**ï¼šè¿½è¸ªæ¯æ¡æ¶ˆæ¯çš„ç”Ÿæˆå’Œæ·»åŠ æ—¶æœº

### æ—¶åºå›¾ï¼ˆä¿®å¤åï¼‰

```
ç”¨æˆ·è¾“å…¥ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                                                                    â–¼
                                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                         â”‚  statefulAgent    â”‚
                                                         â”‚     stream()      â”‚
                                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                   â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                                    â”‚                                    â”‚
                              â–¼                                    â–¼                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Chunk 1 (æ–‡æœ¬)   â”‚              â”‚  Chunk 2 (å·¥å…·)   â”‚              â”‚  Chunk 3 (æ–‡æœ¬)   â”‚
                    â”‚  "æˆ‘æ¥å¸®æ‚¨è®°å½•..." â”‚              â”‚  category.search â”‚              â”‚  "å·²æˆåŠŸè®°å½•..." â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚                                  â”‚                                  â”‚
                              â–¼                                  â”‚                                  â–¼
                    â¸ï¸ ç¼“å­˜ï¼ˆä¸æ˜¾ç¤ºï¼‰                             â”‚                        â¸ï¸ ç¼“å­˜ï¼ˆä¸æ˜¾ç¤ºï¼‰
                              â”‚                                  â”‚                                  â”‚
                              â”‚                                  â–¼                                  â”‚
                              â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
                              â”‚                    â”‚  onStep callback è§¦å‘     â”‚                    â”‚
                              â”‚                    â”‚  seq=1: tool_call        â”‚                    â”‚
                              â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                              â”‚                              â”‚                                      â”‚
                              â”‚                              â–¼                                      â”‚
                              â”‚                    setMessages([seq=1] tool call)                  â”‚
                              â”‚                              â”‚                                      â”‚
                              â”‚                              â–¼                                      â”‚
                              â”‚                    å·¥å…·æ‰§è¡Œ...                                       â”‚
                              â”‚                              â”‚                                      â”‚
                              â”‚                              â–¼                                      â”‚
                              â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
                              â”‚                    â”‚  onStep callback è§¦å‘     â”‚                    â”‚
                              â”‚                    â”‚  seq=2: tool_result      â”‚                    â”‚
                              â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
                              â”‚                              â”‚                                      â”‚
                              â”‚                              â–¼                                      â”‚
                              â”‚                    setMessages([seq=2] tool result)                â”‚
                              â”‚                              â”‚                                      â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                   â”‚  Stream å®Œæˆ          â”‚
                                                   â”‚  finally å—æ‰§è¡Œ       â”‚
                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
                                                             â–¼
                                                   setMessages([seq=3] AI final)
                                                             â”‚
                                                             â–¼
                                                   æ¶ˆæ¯æŒ‰ sequence æ’åº
                                                             â”‚
                                                             â–¼
                                                   âœ… æ­£ç¡®é¡ºåºæ˜¾ç¤ºï¼š
                                                      [seq=0] ç”¨æˆ·æ¶ˆæ¯
                                                      [seq=1] å·¥å…·è°ƒç”¨
                                                      [seq=2] å·¥å…·ç»“æœ
                                                      [seq=3] AI æ€»ç»“

âœ… ç»“æœï¼šç”¨æˆ·æŒ‰ç…§çœŸå®æ‰§è¡Œé¡ºåºçœ‹åˆ°æ‰€æœ‰æ¶ˆæ¯
```

### ä»£ç ä¿®æ”¹è¦ç‚¹

#### 1. æ·»åŠ åºå·å­—æ®µï¼ˆtypes/agent.tsï¼‰
```typescript
export interface AgentMessage {
  id: string;
  type: MessageType;
  sender: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: Date;
  status?: 'sending' | 'sent' | 'error';
  sequence?: number; // âœ¨ æ–°å¢ï¼šæ¶ˆæ¯åºå·
  metadata?: AgentMessageMetadata;
}
```

#### 2. å¼•å…¥åºå·è®¡æ•°å™¨ï¼ˆAgentContext.tsxï¼‰
```typescript
// æ¶ˆæ¯åºå·è®¡æ•°å™¨
let messageSequence = 0;
const getNextSequence = () => messageSequence++;

// ç”¨æˆ·æ¶ˆæ¯: sequence = 0
// æ€è€ƒæ¶ˆæ¯: sequence = 1
// å·¥å…·è°ƒç”¨: sequence = 2
// å·¥å…·ç»“æœ: sequence = 3
// åµŒå…¥å†…å®¹: sequence = 4
// AI æœ€ç»ˆå“åº”: sequence = 5
```

#### 3. å»¶è¿Ÿ AI æ–‡æœ¬è¾“å‡º
```typescript
// âŒ ä¿®å¤å‰ï¼šåœ¨ stream ä¸­ç«‹å³æ›´æ–°
for await (const chunk of stream) {
  finalContent = lastMsg.content;
  setMessages(prev => prev.map(m => m.id === aiMsgId ? {...m, content: finalContent} : m));
}

// âœ… ä¿®å¤åï¼šåªç¼“å­˜ï¼Œä¸æ›´æ–°
for await (const chunk of stream) {
  finalContent = lastMsg.content;
  // ä¸æ›´æ–°ç•Œé¢ï¼Œç­‰æ‰€æœ‰æ­¥éª¤å®Œæˆåå†æ·»åŠ 
}

// åœ¨ finally å—ä¸­ç»Ÿä¸€æ·»åŠ 
if (finalContent) {
  const seq = getNextSequence();
  setMessages(prev => [...prev, {
    id: `assistant_final_${Date.now()}`,
    content: finalContent,
    sequence: seq, // ç¡®ä¿åœ¨æ‰€æœ‰å·¥å…·è°ƒç”¨ä¹‹å
  }]);
}
```

#### 4. æŒ‰åºå·æ’åºï¼ˆfinally å—ï¼‰
```typescript
finally {
  setMessages(prev => {
    // 1. åˆ é™¤å ä½ç¬¦
    let filtered = prev.filter(m => ...);
    
    // 2. æŒ‰åºå·æ’åº
    filtered.sort((a, b) => {
      const seqA = a.sequence ?? 999999;
      const seqB = b.sequence ?? 999999;
      return seqA - seqB;
    });
    
    return filtered;
  });
}
```

#### 5. æ·»åŠ è¯¦ç»†æ—¥å¿—
```typescript
console.log('ğŸ¬ [AgentContext] ========== å¼€å§‹æ–°çš„å¯¹è¯è½®æ¬¡ ==========');
console.log('ğŸ“¥ [AgentContext] ç”¨æˆ·è¾“å…¥:', content);
console.log(`ğŸ¤” [AgentContext] Thinking start [seq=${seq}]`);
console.log(`ğŸ”§ [AgentContext] Tool call [seq=${seq}]:`, toolName);
console.log(`âœ… [AgentContext] Tool result:`, toolName);
console.log(`ğŸ¨ [AgentContext] Embedded content [seq=${seq}]`);
console.log(`ğŸ’¬ [AgentContext] Final AI response [seq=${seq}]`);
console.log('ğŸ“Š [AgentContext] Message order:', messages.map(m => `[${m.sequence}] ${m.type}`));
console.log('ğŸ¬ [AgentContext] ========== å¯¹è¯è½®æ¬¡ç»“æŸ ==========');
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. æ‰“å¼€ Agent èŠå¤©ç•Œé¢
2. å‘é€ï¼š"ä¿®ç©ºè°ƒ50å…ƒ"
3. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—å’Œç•Œé¢æ˜¾ç¤ºé¡ºåº

### é¢„æœŸæ—¥å¿—è¾“å‡º

```
ğŸ¬ [AgentContext] ========== å¼€å§‹æ–°çš„å¯¹è¯è½®æ¬¡ ==========
ğŸ“¥ [AgentContext] ç”¨æˆ·è¾“å…¥: ä¿®ç©ºè°ƒ50å…ƒ
ğŸ“¤ [AgentContext] æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ [seq=0]: user_1765535776304
ğŸ¤– [AgentContext] æ·»åŠ  AI å ä½ç¬¦: assistant_1765535776305
ğŸš€ [AgentContext] Starting stream execution...
ğŸ¤” [AgentContext] Thinking start [seq=1]
ğŸ“ [AgentContext] Chunk 1: content length=45
ğŸ”§ [AgentContext] Tool call [seq=2]: category
   Args: {action: "search", keyword: "ç»´ä¿®", type: "EXPENSE"}
âœ… [AgentContext] Tool result: category
   Result: æ‰¾åˆ°åŒ¹é…çš„åˆ†ç±»...
ğŸ”§ [AgentContext] Tool call [seq=3]: transaction
   Args: {action: "create", data: {...}}
âœ… [AgentContext] Tool result: transaction
   Result: äº¤æ˜“åˆ›å»ºæˆåŠŸ...
ğŸ”§ [AgentContext] Tool call [seq=4]: render_transaction_detail
   Args: {id: 464, ...}
ğŸ¨ [AgentContext] Embedded content [seq=5]: render_transaction_detail
âœ… [AgentContext] Tool result: render_transaction_detail
   Result: âœ… å·²æ¸²æŸ“
âœ… [AgentContext] Stream completed. Total chunks: 5
ğŸ’¬ [AgentContext] Final AI response [seq=6]: å·²æˆåŠŸè®°å½•ä¸€ç¬”ä¿®ç©ºè°ƒçš„æ”¯å‡º...
ğŸ [AgentContext] Finalizing...
ğŸ“Š [AgentContext] Final message count: 7
ğŸ“Š [AgentContext] Message order: [0] text â†’ [1] thinking â†’ [2] tool_call â†’ [2] tool_result â†’ [3] tool_call â†’ [3] tool_result â†’ [4] tool_call â†’ [4] tool_result â†’ [5] embedded â†’ [6] text
ğŸ¬ [AgentContext] ========== å¯¹è¯è½®æ¬¡ç»“æŸ ==========
```

### é¢„æœŸç•Œé¢é¡ºåº

```
[ç”¨æˆ·] ä¿®ç©ºè°ƒ50å…ƒ

[æ€è€ƒä¸­] æˆ‘æ¥å¸®æ‚¨è®°å½•è¿™ç¬”ä¿®ç©ºè°ƒçš„æ”¯å‡º...

[å·¥å…·è°ƒç”¨] åˆ†ç±»ç®¡ç† - æœç´¢åˆ†ç±»
[å·¥å…·ç»“æœ] âœ… å·²å®Œæˆ - æ‰¾åˆ°åŒ¹é…çš„åˆ†ç±»

[å·¥å…·è°ƒç”¨] äº¤æ˜“ç®¡ç† - åˆ›å»ºäº¤æ˜“
[å·¥å…·ç»“æœ] âœ… å·²å®Œæˆ - äº¤æ˜“åˆ›å»ºæˆåŠŸ

[å·¥å…·è°ƒç”¨] æ¸²æŸ“äº¤æ˜“è¯¦æƒ…
[äº¤æ˜“è¯¦æƒ…å¡ç‰‡] ä¿®ç©ºè°ƒ -Â¥50.00

[AI] å·²æˆåŠŸè®°å½•ä¸€ç¬”ä¿®ç©ºè°ƒçš„æ”¯å‡ºï¼Œé‡‘é¢50å…ƒ...
```

## å…³é”®æ”¹è¿›

1. âœ… **æ¶ˆæ¯é¡ºåºä¸¥æ ¼æŒ‰ç…§æ‰§è¡Œé¡ºåº**ï¼šç”¨æˆ·æ°¸è¿œçœ‹åˆ°æ­£ç¡®çš„æ—¶é—´çº¿
2. âœ… **è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—**ï¼šä¾¿äºè¿½è¸ªé—®é¢˜å’Œç†è§£æ‰§è¡Œæµç¨‹
3. âœ… **å»¶è¿Ÿæ¸²æŸ“æœºåˆ¶**ï¼šé¿å…éƒ¨åˆ†æ¶ˆæ¯è¿‡æ—©æ˜¾ç¤º
4. âœ… **åºå·æ’åºä¿è¯**ï¼šå³ä½¿å¼‚æ­¥æ›´æ–°ï¼Œæœ€ç»ˆé¡ºåºä¹Ÿæ˜¯æ­£ç¡®çš„
5. âœ… **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ’åºä¸ä¼šæ”¹å˜ç»“æœ

## æ½œåœ¨é—®é¢˜å’Œåç»­ä¼˜åŒ–

### 1. æ€§èƒ½ä¼˜åŒ–
**é—®é¢˜**ï¼šæ¯æ¬¡ finally å—éƒ½ä¼šå¯¹æ‰€æœ‰æ¶ˆæ¯é‡æ–°æ’åº  
**ä¼˜åŒ–**ï¼šå¯ä»¥è€ƒè™‘ä½¿ç”¨ stable sort æˆ–åªå¯¹æ–°æ·»åŠ çš„æ¶ˆæ¯æ’åº

### 2. å®æ—¶æ›´æ–°
**é—®é¢˜**ï¼šAI æ–‡æœ¬ç°åœ¨è¦ç­‰åˆ°æœ€åæ‰æ˜¾ç¤ºï¼Œå¤±å»äº†æµå¼è¾“å‡ºçš„ä½“éªŒ  
**ä¼˜åŒ–**ï¼šå¯ä»¥è€ƒè™‘ï¼š
- ä¸º AI æ–‡æœ¬åˆ›å»ºä¸´æ—¶æ¶ˆæ¯ï¼Œæ ‡è®°ä¸º"æ­£åœ¨ç”Ÿæˆ"
- æœ€ç»ˆç¡®è®¤é¡ºåºåæ›¿æ¢ä¸ºæœ€ç»ˆæ¶ˆæ¯

### 3. æ¶ˆæ¯åˆ†ç»„
**é—®é¢˜**ï¼šå¤§é‡å·¥å…·è°ƒç”¨ä¼šè®©ç•Œé¢å¾ˆé•¿  
**ä¼˜åŒ–**ï¼šå¯ä»¥è€ƒè™‘å°†ç›¸åŒè½®æ¬¡çš„æ¶ˆæ¯æŠ˜å æˆç»„

## ç›¸å…³æ–‡ä»¶

- âœ… [types/agent.ts](src/types/agent.ts) - æ·»åŠ  sequence å­—æ®µ
- âœ… [AgentContext.tsx](src/context/AgentContext.tsx) - æ ¸å¿ƒæ¶ˆæ¯å¤„ç†é€»è¾‘
- [MessageList.tsx](src/components/agent/MessageList.tsx) - æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“
- [MessageBubble.tsx](src/components/agent/MessageBubble.tsx) - å•æ¡æ¶ˆæ¯æ¸²æŸ“

---

**ä¿®å¤æ—¥æœŸ**: 2025-12-12  
**é—®é¢˜ç±»å‹**: æ¶ˆæ¯é¡ºåºé”™ä¹±  
**æ ¹æœ¬åŸå› **: å¹¶è¡Œå¼‚æ­¥è·¯å¾„å¯¼è‡´çš„ç«æ€æ¡ä»¶  
**è§£å†³æ–¹æ¡ˆ**: åºå·æœºåˆ¶ + å»¶è¿Ÿæ¸²æŸ“ + ç»Ÿä¸€æ’åº
